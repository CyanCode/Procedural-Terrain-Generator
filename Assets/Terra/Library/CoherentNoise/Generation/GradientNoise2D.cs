using Terra.CoherentNoise.Interpolation;
using UnityEngine;

namespace Terra.CoherentNoise.Generation
{
	/// <summary>
	/// This is the same settings as <see cref="GradientNoise"/>, but it does not change in Z direction. This is more efficient if you're only interested in 2D settings anyway.
	/// </summary>
	public class GradientNoise2D : Generator
	{
		// 256 random vectors
		private static readonly float[] Vectors = new[]
		                                          	{
		                                          		-0.731431341826129f, 0.68191509163123f,
		                                          		0.850826255327452f, -0.525447126974223f,
		                                          		0.951901184669578f, -0.306405180479466f,
		                                          		0.847375274477774f, -0.530994486038901f,
		                                          		0.848652296864435f, 0.528951112132982f,
		                                          		0.367039509662365f, 0.930205352783358f,
		                                          		0.993031254071925f, -0.117851297983264f,
		                                          		-0.671151386173851f, -0.741320319994615f,
		                                          		-0.520675077759241f, -0.853754919986063f,
		                                          		0.797453600237253f, -0.603380274344997f,
		                                          		0.261253746745916f, 0.965270158976864f,
		                                          		-0.4665434272427f, 0.884498293099899f,
		                                          		0.988416259834662f, -0.151767247107068f,
		                                          		0.243393593738193f, 0.96992760478667f,
		                                          		0.366768847231788f, -0.93031210499502f,
		                                          		0.411298702005218f, -0.911500618611322f,
		                                          		0.207341022783915f, -0.978268726000643f,
		                                          		-0.738546389576949f, 0.674202662737885f,
		                                          		-0.394654589200276f, -0.918829557221121f,
		                                          		-0.571211615051746f, 0.820802833103039f,
		                                          		-0.322822891839912f, -0.946459391893871f,
		                                          		0.297290895653234f, -0.95478695181789f,
		                                          		0.955458211448602f, -0.295126424054909f,
		                                          		0.144935573935015f, 0.989441094460973f,
		                                          		-0.472190238715513f, 0.881496669569311f,
		                                          		-0.999147653977811f, -0.0412791176097179f,
		                                          		-0.0566039180894319f, -0.998396712963802f,
		                                          		0.838467522782852f, 0.544951569626502f,
		                                          		0.748568021004782f, -0.663058004950535f,
		                                          		-0.527875842628975f, 0.849321549690545f,
		                                          		0.357699899706583f, 0.933836592638081f,
		                                          		0.349221591518296f, -0.93704016990598f,
		                                          		0.989238396385076f, 0.146312662191223f,
		                                          		0.333538104376736f, -0.942736619066414f,
		                                          		0.234353839405063f, 0.972151365763638f,
		                                          		0.62765151947276f, 0.778494425223158f,
		                                          		-0.179494348130198f, 0.983759004527692f,
		                                          		-0.659780814342818f, 0.751458100645091f,
		                                          		-0.718415278792677f, -0.69561446735763f,
		                                          		-0.998033869930316f, -0.0626769054111391f,
		                                          		0.673068523904019f, -0.739580125564272f,
		                                          		-0.739350670868863f, 0.673320566658826f,
		                                          		-0.933271553810173f, 0.359171556291344f,
		                                          		-0.662381939929279f, 0.749166313748507f,
		                                          		-0.0801366250317778f, -0.996783888979209f,
		                                          		0.29025385297949f, -0.956949685631675f,
		                                          		-0.54032917870841f, -0.841453729349568f,
		                                          		-0.692344483921232f, -0.721567124794252f,
		                                          		-0.887159876903364f, 0.461462190014316f,
		                                          		-0.991828148906124f, 0.12758104497711f,
		                                          		0.0810979161066969f, -0.99670613924223f,
		                                          		-0.539198809344358f, 0.842178510769318f,
		                                          		0.969429412401646f, 0.245370361638484f,
		                                          		0.955780929362972f, 0.294079606681682f,
		                                          		0.806781534755456f, 0.590849858405357f,
		                                          		-0.868531510457536f, -0.495633952975733f,
		                                          		0.968002263782507f, -0.250941461922778f,
		                                          		-0.165205532592608f, -0.986259160667617f,
		                                          		-0.868192204140243f, -0.496228069208208f,
		                                          		-0.86976358662251f, -0.493468644784598f,
		                                          		-0.949489840940752f, 0.313797772379451f,
		                                          		0.768401205829135f, -0.63996842647144f,
		                                          		-0.010864092537854f, -0.999940984005221f,
		                                          		-0.450260656290424f, 0.892897161714f,
		                                          		-0.278209506633843f, -0.960520416450662f,
		                                          		-0.813261464544128f, 0.581898436402385f,
		                                          		-0.332109371842527f, 0.943240883939178f,
		                                          		0.472751027063131f, 0.881196043120233f,
		                                          		0.999956668864357f, -0.00930915644399175f,
		                                          		-0.494039763195941f, -0.869439309199497f,
		                                          		-0.970522733594673f, -0.241009592290273f,
		                                          		-0.87192758761998f, 0.489634845519804f,
		                                          		0.0615978842377382f, -0.998101047318073f,
		                                          		0.451468040192217f, 0.892287290442377f,
		                                          		-0.991514020949566f, 0.129999793309158f,
		                                          		-0.398591252415884f, 0.91712867881096f,
		                                          		-0.620385451531012f, 0.784297068417741f,
		                                          		-0.853977038819679f, -0.520310692921809f,
		                                          		-0.997873589794849f, 0.0651789750605269f,
		                                          		-0.980602996956203f, -0.196004495766075f,
		                                          		0.574603098739222f, -0.818432207894633f,
		                                          		0.75959965603487f, 0.650390930557697f,
		                                          		-0.492380199527919f, -0.870380226747395f,
		                                          		-0.82704446775552f, 0.562136503311241f,
		                                          		-0.889333633567567f, -0.457258885321551f,
		                                          		0.593585750865447f, -0.80477074770987f,
		                                          		0.108623796903932f, -0.994082929511504f,
		                                          		0.988522764008209f, -0.151071986276644f,
		                                          		-0.287923414140447f, -0.957653438144357f,
		                                          		-0.685374918424191f, -0.728190374280678f,
		                                          		0.41221156255193f, 0.911088155832626f,
		                                          		-0.94058787072448f, -0.339550375417241f,
		                                          		0.199921957079754f, -0.979811824320058f,
		                                          		0.968115378066659f, 0.250504720017107f,
		                                          		0.927955147115966f, 0.372691890092857f,
		                                          		0.990494594580402f, -0.137551656140541f,
		                                          		-0.665248455869535f, -0.746622054297353f,
		                                          		0.740918725496693f, 0.671594700848924f,
		                                          		-0.535308586961631f, -0.844656567324935f,
		                                          		-0.514854957391123f, 0.857277302189778f,
		                                          		-0.999030092148431f, 0.0440326581289129f,
		                                          		-0.996926870958181f, 0.078337819484146f,
		                                          		-0.685597302598936f, -0.727981001585249f,
		                                          		0.0370788877945427f, -0.999312341602924f,
		                                          		0.931843510698615f, -0.362860402315931f,
		                                          		-0.558733566868429f, 0.829347213930621f,
		                                          		-0.873792759466752f, -0.486298481905381f,
		                                          		0.656607252062933f, -0.754232667376828f,
		                                          		-0.909439904334537f, -0.415835376566243f,
		                                          		0.220309287650761f, -0.975430068110889f,
		                                          		0.150100056956946f, 0.988670811191228f,
		                                          		-0.696084180859879f, 0.717960175188451f,
		                                          		0.100570876625785f, 0.994929896412165f,
		                                          		0.948614809804062f, 0.316433156638814f,
		                                          		-0.095898219566003f, -0.99539114496969f,
		                                          		-0.517140931402395f, 0.855900261168475f,
		                                          		0.178670325099743f, 0.98390899728011f,
		                                          		-0.55311824063568f, 0.833102761894408f,
		                                          		-0.00785321536084002f, -0.999969163028789f,
		                                          		0.60785753484444f, -0.79404610529417f,
		                                          		-0.666794850491482f, -0.745241321558354f,
		                                          		-0.470794948080833f, 0.882242663251764f,
		                                          		-0.979996510123714f, 0.199014673191053f,
		                                          		-0.678566382235446f, 0.734539083303195f,
		                                          		-0.995784759576747f, 0.0917208405689818f,
		                                          		0.994696809022833f, -0.102850659306556f,
		                                          		-0.654067480988245f, -0.756436203730158f,
		                                          		-0.19039516442027f, -0.981707533517686f,
		                                          		0.751490328435529f, 0.659744106656407f,
		                                          		-0.999970965068827f, -0.00762030309888781f,
		                                          		-0.419586283036086f, -0.90771545711636f,
		                                          		0.0670745569756537f, 0.99774796607486f,
		                                          		0.896625085774033f, -0.442790532374742f,
		                                          		0.569636620454938f, 0.821896660558173f,
		                                          		0.971021303456385f, 0.238992945991848f,
		                                          		-0.636951463831028f, 0.770903906283728f,
		                                          		-0.994251716281941f, 0.107067850778906f,
		                                          		0.851524792305273f, -0.524314340915315f,
		                                          		-0.974653098085159f, 0.223721564434458f,
		                                          		0.117674170632817f, 0.99305225923205f,
		                                          		-0.127312138335695f, 0.991862701906062f,
		                                          		0.821092992312965f, -0.570794444589767f,
		                                          		-0.836180971630179f, 0.548453628562716f,
		                                          		0.87069175612852f, -0.491829102239623f,
		                                          		-0.822815382334055f, 0.568308759913537f,
		                                          		0.367191064113784f, -0.93014553830838f,
		                                          		-0.432424566542929f, 0.901670113872119f,
		                                          		-0.120396019190764f, -0.992725943331299f,
		                                          		-0.3421907211692f, 0.939630517994016f,
		                                          		-0.160896503013349f, -0.986971283937925f,
		                                          		0.0416336791557611f, -0.999132942485611f,
		                                          		-0.254051840030241f, 0.967190603023648f,
		                                          		-0.677392585218673f, 0.73562169998632f,
		                                          		0.34530489954395f, -0.93849055741171f,
		                                          		-0.295575835287478f, -0.955319279400405f,
		                                          		0.509185809941917f, 0.860656616168024f,
		                                          		0.992575229930708f, 0.121632285713957f,
		                                          		-0.0695072162716299f, 0.997581448748005f,
		                                          		-0.12858035933064f, 0.991699093069265f,
		                                          		0.964222198214983f, -0.26509536485851f,
		                                          		-0.261898801454652f, -0.965095341298784f,
		                                          		0.643768799332641f, -0.765220055282015f,
		                                          		-0.00416655784368122f, -0.999991319860195f,
		                                          		0.912582290418183f, 0.408893095093452f,
		                                          		0.792974195036607f, 0.609255222387174f,
		                                          		0.996512185806037f, -0.0834473698811023f,
		                                          		-0.942032506564994f, 0.335521618640103f,
		                                          		0.87501841362795f, 0.484089636133666f,
		                                          		0.996750481408581f, 0.0805510882096704f,
		                                          		-0.706268410606012f, 0.707944158941973f,
		                                          		0.605807660050887f, -0.795611135557861f,
		                                          		-0.363735385957895f, 0.931502318302033f,
		                                          		0.725481460068661f, -0.688241709791439f,
		                                          		-0.993945757112509f, -0.109871888661487f,
		                                          		-0.86497235799957f, -0.501819509282633f,
		                                          		-0.122120972824683f, -0.99251522305522f,
		                                          		0.877538967058075f, -0.479505329787529f,
		                                          		-0.951156090447505f, -0.308710368476048f,
		                                          		0.975779852778161f, -0.218754837460183f,
		                                          		-0.450956996122408f, -0.892545678185859f,
		                                          		-0.522868702172098f, -0.85241323329056f,
		                                          		0.829680964911082f, -0.558237849365497f,
		                                          		-0.85729089961775f, 0.514832315839429f,
		                                          		-0.772060653910783f, 0.635548854678265f,
		                                          		-0.0340187744669282f, -0.999421193983682f,
		                                          		-0.771337193085491f, 0.636426692214426f,
		                                          		0.688529247409745f, -0.725208573764382f,
		                                          		0.725163768716788f, 0.688576436236722f,
		                                          		-0.953544545407338f, 0.301252053808622f,
		                                          		0.700121129056667f, -0.714024092484573f,
		                                          		-0.538455441479676f, 0.842653984468671f,
		                                          		0.175916570766405f, 0.984405079288902f,
		                                          		-0.629451420142488f, -0.777039837898036f,
		                                          		-0.999089702483185f, -0.0426587200002751f,
		                                          		-0.989208833301989f, -0.146512402605778f,
		                                          		-0.840952814021566f, 0.541108459173583f,
		                                          		0.567368358566675f, 0.823464113181235f,
		                                          		-0.538825044596127f, 0.842417694090041f,
		                                          		0.390786645379538f, -0.920481285954803f,
		                                          		-0.867369426459715f, 0.497664825000668f,
		                                          		-0.657989855099474f, 0.75302679274125f,
		                                          		0.0581096991068076f, 0.99831020372914f,
		                                          		-0.199969945117378f, -0.979802031560331f,
		                                          		0.90688443354178f, -0.42137943020466f,
		                                          		0.687773009975965f, -0.725925813529593f,
		                                          		-0.945838294573846f, 0.324638137805216f,
		                                          		-0.849970814157478f, 0.526829778088211f,
		                                          		0.592467340459703f, -0.805594470244556f,
		                                          		0.172273677799394f, 0.985049125646772f,
		                                          		0.98426493623182f, -0.176698996331532f,
		                                          		0.034140955127593f, 0.999417027663115f,
		                                          		-0.981643122917266f, 0.190726975620226f,
		                                          		-0.286049508934714f, 0.958214839395743f,
		                                          		-0.827152526975724f, -0.561977488087979f,
		                                          		-0.278190812296812f, 0.960525830966372f,
		                                          		0.321460297459343f, -0.946923057675412f,
		                                          		-0.945857146313334f, 0.324583207772671f,
		                                          		-0.632326502652004f, 0.774702003381871f,
		                                          		-0.439701356430231f, 0.898144040315035f,
		                                          		-0.22390420389053f, -0.974611157067344f,
		                                          		0.746644533423535f, 0.665223226224665f,
		                                          		-0.452095562270814f, 0.891969507648684f,
		                                          		-0.688536038333179f, -0.725202126249263f,
		                                          		0.640330654773997f, 0.768099376745421f,
		                                          		0.976846035149785f, 0.213943505655453f,
		                                          		-0.676632036881798f, -0.736321320257121f,
		                                          		-0.494860655167783f, -0.868972342463736f,
		                                          		-0.695461545706562f, 0.718563315542507f,
		                                          		0.999317517145356f, -0.036939138138857f,
		                                          		0.455862157059439f, 0.89005038832704f,
		                                          		-0.886588243870148f, -0.46255949436937f,
		                                          		-0.876783747283401f, -0.480884872396375f,
		                                          		-0.0875369808558837f, -0.996161270569498f,
		                                          		-0.95522819915781f, -0.295870051768894f,
		                                          		-0.375385680884685f, 0.92686870191346f,
		                                          		-0.881356571543301f, 0.472451684087843f,
		                                          		0.381051321883982f, 0.924553887066876f,
		                                          		-0.994403519779731f, 0.105648662318475f,
		                                          		-0.992363799194351f, -0.123345409515526f,
		                                          		-0.292273975672636f, 0.956334629271842f,
		                                          		0.990902635025559f, -0.134580711468633f,
		                                          		0.9921551088401f, 0.12501295933818f,
		                                          		0.803208245899664f, -0.59569834120869f,
		                                          		-0.99177139673035f, 0.128021469400765f,
		                                          		-0.689705032139782f, -0.724090442307494f,
		                                          		0.689287927077946f, -0.724487510992831f,
		                                          		0.892950706269959f, -0.45015445812741f,
		                                          		0.957331229025545f, 0.288992937513079f,
		                                          		0.236962773414951f, 0.971518730656025f,
		                                          		-0.179255393539833f, -0.983802573632982f,
		                                          		0.971055948286095f, -0.238852141079356f,
		                                          		0.279177248306704f, -0.960239586784411f,
		                                          		0.993534534390401f, 0.113530299804277f,
		                                          		0.809612558438491f, 0.586964654147659f,
		                                          		-0.316558440259375f, 0.948573009262098f,
		                                          		0.969151231077369f, 0.246466815821563f,
		                                          	};

		private readonly int m_Seed;
		private readonly SCurve m_SCurve;

		/// <summary>
		/// Create new generator with specified seed
		/// </summary>
		/// <param name="seed">settings seed</param>
		public GradientNoise2D(int seed)
			: this(seed, null)
		{
		}
		/// <summary>
		/// Create new generator with specified seed and interpolation algorithm. Different interpolation algorithms can make settings smoother at the expense of speed.
		/// </summary>
		/// <param name="seed">settings seed</param>
		/// <param name="sCurve">Interpolator to use. Can be null, in which case default will be used</param>
		public GradientNoise2D(int seed, SCurve sCurve)
		{
			m_Seed = seed;
			m_SCurve = sCurve;
		}

		/// <summary>
		/// Noise period. Used for repeating (seamless) settings.
		/// When Period &gt;0 resulting settings pattern repeats exactly every Period, for all coordinates.
		/// </summary>
		public int Period { get; set; }

		private SCurve SCurve { get { return m_SCurve ?? SCurve.Default; } }

		#region Implementation of Noise

		/// <summary>
		/// Returns settings value at given point. 
		/// </summary>
		/// <param name="x">X coordinate</param>
		/// <param name="y">Y coordinate</param>
		/// <param name="z">Z coordinate</param>
		/// <returns>Noise value</returns>
		public override float GetValue(float x, float y, float z)
		{
			int ix = Mathf.FloorToInt(x);
			int iy = Mathf.FloorToInt(y);

			// interpolate the coordinates instead of values - this way we need only 4 calls instead of 7
			float xs = SCurve.Interpolate(x - ix);
			float ys = SCurve.Interpolate(y - iy);

			// THEN we can use linear interp to find our value - triliear actually

			float n0 = GetNoise(x, y, ix, iy);
			float n1 = GetNoise(x, y, ix + 1, iy);
			float ix0 = Mathf.Lerp(n0, n1, xs);

			n0 = GetNoise(x, y, ix, iy + 1);
			n1 = GetNoise(x, y, ix + 1, iy + 1);
			float ix1 = Mathf.Lerp(n0, n1, xs);

			return Mathf.Lerp(ix0, ix1, ys);
		}

		Vector2 GetRandomVector(int x, int y)
		{
			if (Period > 0)
			{
				// make periodic lattice. Repeat every Period cells
				x = x % Period; if (x < 0) x += Period;
				y = y % Period; if (y < 0) y += Period;
			}

			int vectorIndex = (
				 Constants.MultiplierX * x
			   + Constants.MultiplierY * y
			   + Constants.MultiplierSeed * m_Seed)
			   & 0x7fffffff;
			vectorIndex = (((vectorIndex >> Constants.ValueShift) ^ vectorIndex) & 0xff) * 2;

			return new Vector2(Vectors[vectorIndex], Vectors[vectorIndex + 1]);
		}

		private float GetNoise(float x, float y, int ix, int iy)
		{
			var gradient = GetRandomVector(ix, iy);
			return Vector2.Dot(gradient, new Vector2(x - ix, y - iy)) * 2.12f; // scale to [-1,1]
		}

		#endregion
	}
}